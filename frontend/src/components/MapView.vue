<template>
    <div>
      <gmap-map
        ref="gmap"
        :center="{lat:32,lng:-79}"
        :zoom="2"
        style="width: 100%; min-height: 40vh;">
          <gmap-info-window :options="infoOptions" :position="infoWindowPosition" :opened="infoWindowOpen" >
            {{infoWindowContent}}
          </gmap-info-window>
          <gmap-marker
            v-for="(malwareItem, index) in malwareWithLocationInfo"
            :position="{
              lat: malwareItem.ipAddressInfo.lat,
              lng: malwareItem.ipAddressInfo.lon}"
            :icon="getMapIcon(malwareItem)"
            @click="toggleInfoWindow(malwareItem, index)"/>
      </gmap-map>
    </div>
</template>

<script>
import {gmapApi} from 'vue2-google-maps'

export default {
  name: 'MapView',
  props: ['malwareData'],
  data () {
    return {
      data: this.malwareData,
      iconActiveThreat: 'http://maps.google.com/mapfiles/kml/paddle/grn-stars-lv.png',
      iconInactiveThreat: 'http://maps.google.com/mapfiles/kml/paddle/blu-square-lv.png',
      currentMapIndex: null,
      infoOptions: {
        pixelOffset: {
          width: 0,
          height: -15
        }
      },
      infoWindowContent: null,
      infoWindowPosition: null,
      infoWindowOpen: false
    }
  },
  mounted () {
    this.setMapBounds()
  },
  methods: {
    getMapIcon (malwareItem) {
      if (malwareItem.urlStatus === 'online') {
        return this.iconActiveThreat
      }
      return this.iconInactiveThreat
    },
    toggleInfoWindow: function (malwareItem, index) {
      this.infoWindowPosition = {lat: malwareItem.ipAddressInfo.lat, lng: malwareItem.ipAddressInfo.lon}
      this.infoWindowContent = malwareItem.url
      // if same marker was clicked, toggle window
      if (this.currentMapIndex === index) {
        this.infoWindowOpen = !this.infoWindowOpen
      }
      // if different marker was clicked, keep window open
      else {
        this.infoWindowOpen = true
        this.currentMapIndex = index
      }
    },
    setMapBounds () {
      this.$refs.gmap.$mapPromise.then((map) => {
        let bounds = new google.maps.LatLngBounds()
        this.malwareWithLocationInfo.forEach((malwareItem) => {
          bounds.extend(new google.maps.LatLng(malwareItem.ipAddressInfo.lat, malwareItem.ipAddressInfo.lon))
        })
        map.fitBounds(bounds)
      })
    }
  },
  computed: {
    google: gmapApi,
    malwareWithLocationInfo () {
      // Filter out the Malware Items that do not have IP Address information
      if (this.data === null || this.data === undefined) {
        return []
      }
      if (this.data.length === 0) {
        return []
      }

      return this.data.filter(item => {
        return item.ipAddressInfo !== null && item.ipAddressInfo !== undefined
      })
    }
  },
  watch: {
    malwareData: function () {
      this.data = this.malwareData
      this.setMapBounds()
    }
  }
}
</script>

<style scoped>

</style>
