<template>
    <div>
      <gmap-map
        ref="gmap"
        :center="{lat:32,lng:-79}"
        :zoom="2"
        style="width: 100%; min-height: 40vh;">
          <gmap-info-window :options="infoOptions" :position="infoWindowPosition" :opened="infoWindowOpen">
            {{infoWindowContent}}
          </gmap-info-window>
          <gmap-marker
            v-for="(malwareItem, index) in malwareWithLocationInfo"
            :position="{
              lat: malwareItem.ipAddressInfo.lat,
              lng: malwareItem.ipAddressInfo.lon}"
            :icon="getMapIcon(malwareItem)"
            @click="toggleInfoWindow(malwareItem, index)" />
      </gmap-map>
    </div>
</template>

<script>
import {gmapApi} from 'vue2-google-maps'

export default {
  name: 'MapView',
  props: ['malwareData'],
  data () {
    return {
      iconOnlineThreat: 'http://maps.google.com/mapfiles/kml/paddle/grn-stars-lv.png',
      iconOfflineThreat: 'http://maps.google.com/mapfiles/kml/paddle/red-square-lv.png',
      currentMapIndex: null,
      infoOptions: {
        pixelOffset: {
          width: 0,
          height: -15
        }
      },
      infoWindowContent: null,
      infoWindowPosition: null,
      infoWindowOpen: false
    }
  },
  methods: {
    getMapIcon (malwareItem) {
      if (malwareItem.urlStatus === 'online') {
        return this.iconOnlineThreat
      }
      return this.iconOfflineThreat
    },
    toggleInfoWindow: function (malwareItem, index) {
      this.infoWindowPosition = {lat: malwareItem.ipAddressInfo.lat, lng: malwareItem.ipAddressInfo.lon}
      this.infoWindowContent = malwareItem.url
      // if same marker was clicked, toggle window
      if (this.currentMapIndex === index) {
        this.infoWindowOpen = !this.infoWindowOpen
      }
      // if different marker was clicked, keep window open
      else {
        this.infoWindowOpen = true
        this.currentMapIndex = index
      }
    },
    setMapBounds () {
      if(this.$refs.gmap !== undefined && this.$refs.gmap.$mapPromise !== undefined  &&
        this.$refs.gmap !== null && this.$refs.gmap.$mapPromise !== null ) {
        this.$refs.gmap.$mapPromise.then((map) => {
          let bounds = new google.maps.LatLngBounds()
          this.malwareWithLocationInfo.forEach((malwareItem) => {
            bounds.extend(new google.maps.LatLng(malwareItem.ipAddressInfo.lat, malwareItem.ipAddressInfo.lon))
          })
          map.fitBounds(bounds)
        })
      }
    }
  },
  computed: {
    getMalwareData () {
      return this.malwareData
    },
    google: gmapApi,
    malwareWithLocationInfo () {
      // Filter out the Malware Items that do not have IP Address information
      if (this.getMalwareData === null || this.getMalwareData === undefined || this.getMalwareData.length === 0) {
        return []
      }

      return this.getMalwareData.filter(item => {
        return item.ipAddressInfo !== null && item.ipAddressInfo !== undefined
      })
    }
  },
  watch: {
    malwareData: function () {
      this.setMapBounds()
    }
  }
}
</script>

<style scoped>

</style>
