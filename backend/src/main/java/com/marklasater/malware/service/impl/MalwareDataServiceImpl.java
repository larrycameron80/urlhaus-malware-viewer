package com.marklasater.malware.service.impl;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.marklasater.malware.model.IpAddressInfo;
import com.marklasater.malware.model.MalwareReport;
import com.marklasater.malware.service.HttpService;
import com.marklasater.malware.service.DataService;
import com.marklasater.malware.service.FeedParser;
import com.mashape.unirest.http.JsonNode;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Service("MalwareDataService")
public class MalwareDataServiceImpl implements DataService<MalwareReport> {

    @Autowired
    HttpService httpService;

    @Autowired
    @Resource(name="MalwareFeedParser")
    FeedParser malwareFeedParser;

    public List<MalwareReport> getData(){
        String response = httpService.getString("https://urlhaus.abuse.ch/downloads/csv", new HashMap<>());
//        String response = "################################################################\n" +
//                "# abuse.ch URLhaus Database Dump (CSV)                         #\n" +
//                "# Last updated: 2018-08-24 16:45:21 (UTC)                      #\n" +
//                "#                                                              #\n" +
//                "# Terms Of Use: https://urlhaus.abuse.ch/api/                  #\n" +
//                "# For questions please contact urlhaus [at] abuse.ch           #\n" +
//                "################################################################\n" +
//                "#\n" +
//                "# id,dateadded,url,url_status,threat,tags,urlhaus_link\n" +
//                "\"47326\",\"2018-08-24 16:45:21\",\"http://www.optisaving.com/wp-content/themes/pixel_wp/tas.exe\",\"online\",\"malware_download\",\"exe,Trickbot\",\"https://urlhaus.abuse.ch/url/47326/\"\n" +
//                "\"47325\",\"2018-08-24 16:45:18\",\"http://lnsect-net.com/file/tt.exe\",\"online\",\"malware_download\",\"exe,Trickbot\",\"https://urlhaus.abuse.ch/url/47325/\"\n" +
//                "\"47324\",\"2018-08-24 16:45:14\",\"https://cld.pt/dl/download/0e24f250-00c7-4480-b589-ec16c9175c45/uxspjto2mryz.doc\",\"online\",\"malware_download\",\"doc,Trickbot\",\"https://urlhaus.abuse.ch/url/47324/\"\n" +
//                "\"47323\",\"2018-08-24 16:45:10\",\"http://92.63.197.60/crab.exe\",\"offline\",\"malware_download\",\"exe,Trickbot\",\"https://urlhaus.abuse.ch/url/47323/\"\n" +
//                "\"47322\",\"2018-08-24 16:45:09\",\"http://nworldorg.com/two/mode.exe\",\"online\",\"malware_download\",\"exe,Trickbot\",\"https://urlhaus.abuse.ch/url/47322/\"\n" +
//                "\"47321\",\"2018-08-24 16:32:07\",\"https://www.gorontula.com/wp-admin/includes/_outputB7E297F.exe\",\"online\",\"malware_download\",\"exe,Formbook\",\"https://urlhaus.abuse.ch/url/47321/\"\n" +
//                "\"47320\",\"2018-08-24 16:32:06\",\"https://www.gorontula.com/wp-admin/includes/_output2011D00.exe\",\"online\",\"malware_download\",\"exe,Formbook\",\"https://urlhaus.abuse.ch/url/47320/\"\n" +
//                "\"47319\",\"2018-08-24 14:51:05\",\"https://www.gorontula.com/wp-admin/includes/_output65E4160.exe\",\"online\",\"malware_download\",\"doc,emotet,Formbook\",\"https://urlhaus.abuse.ch/url/47319/\"\n" +
//                "\"47318\",\"2018-08-24 14:38:10\",\"http://wp1.lukas.fr/9lvv9kkr/\",\"online\",\"malware_download\",\"exe,Fuery\",\"https://urlhaus.abuse.ch/url/47318/\"\n" +
//                "\"47317\",\"2018-08-24 14:38:09\",\"http://smed13.inducido.com/47485EUD/SWIFT/Commercial/\",\"online\",\"malware_download\",\"doc,heodo\",\"https://urlhaus.abuse.ch/url/47317/\"\n" +
//                "\"47316\",\"2018-08-24 14:38:06\",\"http://cuentocontigo.net/78768KDGW/WIRE/Business/\",\"online\",\"malware_download\",\"doc,heodo\",\"https://urlhaus.abuse.ch/url/47316/\"\n" +
//                "\"47315\",\"2018-08-24 14:38:03\",\"https://cld.pt/dl/download/f2ef7350-6739-4547-871d-d73feb54c574/1522RTADOCMRTPASD1535106361.zip\",\"online\",\"malware_download\",\"zip\",\"https://urlhaus.abuse.ch/url/47315/\"\n" +
//                "\"47314\",\"2018-08-24 14:25:10\",\"http://wp-test-paul.dev-thuria.com/scan/En_us/196-95-085040-727-196-95-085040-920\",\"online\",\"malware_download\",\"doc,emotet,heodo\",\"https://urlhaus.abuse.ch/url/47314/\"\n" +
//                "\"47313\",\"2018-08-24 14:25:05\",\"http://xn--26-6kcaalesi4enatg5a2l.xn--p1ai/2018004Z/identity/Personal\",\"online\",\"malware_download\",\"doc,emotet,heodo\",\"https://urlhaus.abuse.ch/url/47313/\"\n" +
//                "\"47312\",\"2018-08-24 14:12:24\",\"https://stemviki.com/dala.exe\",\"offline\",\"malware_download\",\"Loki\",\"https://urlhaus.abuse.ch/url/47312/\"\n" +
//                "\"47311\",\"2018-08-24 14:12:22\",\"http://jensweightloss.com/images/2799IXNL/com/Commercial\",\"online\",\"malware_download\",\"doc,emotet,heodo\",\"https://urlhaus.abuse.ch/url/47311/\"\n" +
//                "\"47310\",\"2018-08-24 14:12:20\",\"http://e3dai.com/68143GMDBECVD/BIZ/Business\",\"online\",\"malware_download\",\"doc,emotet,heodo\",\"https://urlhaus.abuse.ch/url/47310/\"\n";
        List<MalwareReport> malwareReports = malwareFeedParser.parseCsvFeed(response);
        int numberOfIpAddressToGet = malwareReports.size() < 15 ? malwareReports.size() : 15;
        for(int i = 0; i < numberOfIpAddressToGet; i++){
            //This is in here to limit the API calls against ip-api.com - The limit is 150 requests / minute
            malwareReports.get(i).setIpAddressInfo(getIpAddressInformation(malwareReports.get(i).getBaseUrl()));
        }

        return malwareReports;
    }

    public IpAddressInfo getIpAddressInformation(String url){
//        JsonNode response = httpService.getJson("http://ip-api.com/json/" + malwareReport.getBaseUrl(), new HashMap<>());
        JsonNode response = new JsonNode("{\"zip\":\"94043\",\"country\":\"United States\",\"city\":\"Mountain View\",\"org\":\"Google Cloud\",\"timezone\":\"America/Los_Angeles\",\"isp\":\"Google Cloud\",\"query\":\"35.198.140.181\",\"regionName\":\"California\",\"lon\":-122.0574,\"as\":\"AS15169 Google LLC\",\"countryCode\":\"US\",\"region\":\"CA\",\"lat\":37.4192,\"status\":\"success\"}");
        ObjectMapper mapper = new ObjectMapper();
        return mapper.convertValue(getMap(response), IpAddressInfo.class);
    }

    private Map<String, Object> getMap(JsonNode node){
        Map<String, Object> map = new HashMap<>();
        node.getObject().keySet().forEach(item -> map.put(item, node.getObject().get(item)));
        return map;
    }
}
